<!DOCTYPE html>
<html lang="th">

<head>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://czp.dga.or.th/cportal/sdk/css/v1/trunks.min.css" />
  <link rel="preconnect" href="https://fonts.gstatic.com">
  <link
    href="https://fonts.googleapis.com/css2?family=Prompt:ital,wght@0,300;0,400;0,500;0,600;0,700;1,300;1,400;1,500;1,600;1,700&display=swap"
    rel="stylesheet">
  <link href="https://fonts.googleapis.com/css?family=Material+Icons|Material+Icons+Round" rel="stylesheet">
  <script src="https://czp.dga.or.th/cportal/sdk/iu/v3/sdk.js"></script>

  <title>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ - DGA Connect</title>

  <style>
    body {
      font-family: 'Prompt', sans-serif;
      background: #f3f5fa;
      margin: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
    }

    .card {
      width: 100%;
      max-width: 520px;
      background: #fff;
      border-radius: 18px;
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.1);
      overflow: hidden;
      animation: fadeIn 0.5s ease;
    }

    .card-header {
      background: #1976d2;
      color: #fff;
      padding: 20px 16px;
      text-align: center;
    }

    .card-body {
      padding: 20px 24px;
      color: #333;
    }

    .info-section {
      background: #f7f8fc;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 20px;
    }

    .info-section h3 {
      margin-top: 0;
      font-size: 16px;
      color: #1976d2;
    }

    .info-row {
      display: flex;
      justify-content: space-between;
      font-size: 15px;
      padding: 4px 0;
    }

    .btn-refresh {
      width: 100%;
      background: #1976d2;
      color: white;
      border: none;
      padding: 12px;
      border-radius: 10px;
      font-size: 16px;
      cursor: pointer;
      transition: background 0.3s;
    }

    .btn-refresh:hover {
      background: #125ca4;
    }

    .error {
      color: red;
      text-align: center;
      margin-top: 10px;
      font-weight: 500;
    }

    .log-box {
      background: #1e1e1e;
      color: #00ff99;
      font-family: monospace;
      font-size: 13px;
      padding: 12px;
      border-radius: 10px;
      height: 160px;
      overflow-y: auto;
      margin-top: 15px;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(15px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .loader-container {
      text-align: center;
      color: #555;
    }

    .spinner {
      border: 5px solid #eee;
      border-top: 5px solid #1976d2;
      border-radius: 50%;
      width: 60px;
      height: 60px;
      animation: spin 1s linear infinite;
      margin: 0 auto 16px;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }
  </style>
</head>

<body>
  <div id="loader" class="loader-container">
    <div class="spinner"></div>
    <p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö ....</p>
  </div>

  <div id="userCard" class="card" style="display:none;">
    <div class="card-header">
      <h2>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</h2>
    </div>

    <div class="card-body">
      <div class="info-section">
        <h3>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß</h3>
        <div class="info-row"><span>‡∏£‡∏´‡∏±‡∏™‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô:</span><span id="citizenId">-</span></div>
        <div class="info-row"><span>‡∏ä‡∏∑‡πà‡∏≠:</span><span id="firstname">-</span></div>
        <div class="info-row"><span>‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•:</span><span id="lastname">-</span></div>
        <div class="info-row"><span>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠:</span><span id="mobile">-</span></div>
        <div class="info-row"><span>‡∏≠‡∏µ‡πÄ‡∏°‡∏•:</span><span id="email">-</span></div>
      </div>

      <div class="info-section">
        <h3>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏∞‡∏ö‡∏ö</h3>
        <div class="info-row"><span>App ID:</span><span id="appId">-</span></div>
        <div class="info-row"><span>mToken:</span><span id="mToken">-</span></div>
        <div class="info-row"><span>Agent ID:</span><span id="agentId">-</span></div>
        <div class="info-row"><span>Consumer Key:</span><span id="consumerKey">-</span></div>
      </div>

      <button class="btn-refresh" onclick="initData()">üîÑ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
      <div class="error" id="errorMsg"></div>

      <div class="info-section">
        <h3>Log</h3>
        <div id="logBox" class="log-box"></div>
      </div>
    </div>
  </div>


  <script>
    async function initData() {
      const loader = document.getElementById("loader");
      const card = document.getElementById("userCard");
      const errorMsg = document.getElementById("errorMsg");
      console.log("‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ...");

      try {
        loader.style.display = "flex";
        card.style.display = "none";
        errorMsg.textContent = "";

        // ‚úÖ [1] Validate ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ç‡∏≠ Token ‡∏à‡∏≤‡∏Å backend (.env)
        const validateRes = await axios.get("/api/validate");
        const token = validateRes.data.token;
        console.log("‚úÖ Token ‡∏à‡∏≤‡∏Å validate:", token);

        // ‚úÖ [2] ‡∏î‡∏∂‡∏á appId ‡πÅ‡∏•‡∏∞ mToken ‡∏à‡∏≤‡∏Å SDK
        const appId =
          (window.czpSdk && window.czpSdk.getAppId?.()) ||
          new URLSearchParams(window.location.search).get("appId");
        const mToken =
          (window.czpSdk && window.czpSdk.getToken?.()) ||
          new URLSearchParams(window.location.search).get("mToken");

        console.log("üì± appId:", appId);
        console.log("üîë mToken:", mToken);

        if (!appId || !mToken) {
          throw new Error("‡πÑ‡∏°‡πà‡∏û‡∏ö appId ‡∏´‡∏£‡∏∑‡∏≠ mToken (‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå)");
        }

        // ‚úÖ [3] ‡∏™‡πà‡∏á appId, mToken, token ‡πÑ‡∏õ backend ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
        const res = await axios.post("/api/login", { appId, mToken, token });
        const data = res.data.user;

        console.log("üë§ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ:", data);

        // ‚úÖ [4] ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï UI
        document.getElementById("appId").textContent = appId;
        document.getElementById("mToken").textContent = mToken;
        document.getElementById("userId").textContent = data.userId || "-";
        document.getElementById("citizenId").textContent = data.citizenId || "-";
        document.getElementById("firstname").textContent = data.firstName || "-";
        document.getElementById("lastname").textContent = data.lastName || "-";
        document.getElementById("mobile").textContent = data.mobile || "-";
        document.getElementById("email").textContent = data.email || "-";
        document.getElementById("testToken").textContent = token;

        loader.style.display = "none";
        card.style.display = "block";
      } catch (err) {
        console.error("‚ùå ERROR:", err);
        loader.style.display = "none";
        card.style.display = "block";
        errorMsg.textContent = "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + err.message;
      }
    }

    window.addEventListener("load", initData);
  </script>

</body>

</html>